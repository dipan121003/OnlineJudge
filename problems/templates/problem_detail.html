<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ problem.title }} â€“ Online Judge</title>

  <!-- Bootstrap CSS -->

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Ace Editor -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.43.2/ace.js"></script>

</head>

<body class="bg-light">

  <div class="container py-5">

    <!-- Problem Header -->
    <div class="mb-4">
      <h1 class="display-5 fw-bold">{{ problem.title }}</h1>
      <p class="text-muted">
        Created: {{ problem.created_at|date:"F d, Y" }} |
        Difficulty:
        <span
          class="badge {% if problem.difficulty == 'Easy' %}bg-success{% elif problem.difficulty == 'Medium' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
          {{ problem.difficulty }}
        </span>
      </p>
      <hr>
    </div>

    <!-- Problem Description -->
    <div class="card mb-5">
      <div class="card-body">
        <h5 class="card-title">Problem Description</h5>
        <p class="card-text" style="white-space: pre-line;">
          {{ problem.description }}
        </p>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Write &amp; Run Your Code</h5>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="language" class="form-label">Language</label>
            <select id="language" class="form-select">
              <option value="py">Python</option>
              <option value="cpp">C++</option>
              <option value="java">Java</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label for="code-editor" class="form-label">Your Code</label>
          <div id="code-editor" style="height:400px; width:100%; border:1px solid #ccc; border-radius:4px;"></div>
        </div>

        <form method="post" action="{% url 'run_code' %}" id="run-form">
          {% csrf_token %}
          <input type="hidden" name="problem" value="{{ problem.id }}">

          <label for="display-input" class="form-label">Custom Input</label>
          <textarea id="display-input" name="input_data" class="form-control font-monospace" rows="4"></textarea>

          <textarea name="code" class="hidden-code" hidden></textarea>
          <input type="hidden" name="language" class="hidden-language">
        </form>

        <form method="post" action="{% url 'submit_solution' problem.id %}" id="submit-form">
          {% csrf_token %}
          <textarea name="code" class="hidden-code" hidden></textarea>
          <input type="hidden" name="language" class="hidden-language">
        </form>

        <div class="d-flex gap-2 mt-3">
          <button type="submit" form="run-form" class="btn btn-secondary">Run Code</button>
          <button type="submit" form="submit-form" class="btn btn-primary">Submit Solution</button>
        </div>
      </div>
    </div>
  </div>

  <script
    src="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js](https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js)"></script>

  <script>
    const editor = ace.edit("code-editor");
    editor.setOptions({
      mode: 'ace/mode/python', // MODIFICATION: Default to 'py' to match the dropdown
      theme: 'ace/theme/monokai',
      fontSize: '14pt',
      showPrintMargin: false,
      wrap: true,
      useWorker: false,
      highlightActiveLine: true,
      readOnly: false
    });
    editor.session.setValue('');
    editor.focus();

    // MODIFICATION: Get references to both forms and all hidden fields
    const runForm = document.getElementById('run-form');
    const submitForm = document.getElementById('submit-form');
    const allHiddenCodeInputs = document.querySelectorAll('.hidden-code');
    const allHiddenLanguageInputs = document.querySelectorAll('.hidden-language');
    const languageDropdown = document.getElementById('language');

    // MODIFICATION: A single function to update hidden fields in both forms
    function updateHiddenFields() {
      const code = editor.getValue();
      const lang = languageDropdown.value;

      allHiddenCodeInputs.forEach(input => {
        input.value = code;
      });

      allHiddenLanguageInputs.forEach(input => {
        input.value = lang;
      });
    }

    // MODIFICATION: Add event listeners to both forms
    runForm.addEventListener('submit', updateHiddenFields);
    submitForm.addEventListener('submit', updateHiddenFields);

    // Switch language mode dynamically (this part remains the same)
    languageDropdown.addEventListener('change', function () {
      const lang = this.value;
      let mode = 'ace/mode/text';
      if (lang === 'py') mode = 'ace/mode/python';
      else if (lang === 'cpp') mode = 'ace/mode/c_cpp';
      else if (lang === 'java') mode = 'ace/mode/java';
      editor.session.setMode(mode);
    });
  </script>

</body>

</html>